@page "/"
@using AsthmaAQ.Client.Models
@using AsthmaAQ.Client.Services
@inject AirQualityService AQService
@inject IJSRuntime JS

<h3>Air Quality Checker</h3>

<EditForm Model="@searchModel" OnValidSubmit="OnSearch">
    <DataAnnotationsValidator />
    <div class="mb-2">
        <InputText @bind-Value="searchModel.City" placeholder="Enter city..." class="form-control" />
        <ValidationMessage For="@(() => searchModel.City)" />
    </div>
    <button type="submit" class="btn btn-primary">Search</button>
</EditForm>

@if (favoriteCities.Count > 0)
{
    <h5 class="mt-3">Favorite Cities</h5>
    @foreach (var city in favoriteCities)
    {
        <button class="btn btn-outline-secondary me-2 mb-2" @onclick="async () => await LoadFavorite(city)">
            @city
        </button>
    }
}

@if (isLoading)
{
    <p>Loading...</p>
}

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}

@if (aqData != null)
{
    <div class="mt-3">
        <h4>@aqData.Data.City.Name</h4>

        <div style="
            background:@GetAqiColor(aqData.Data.AQI);
            color:white;
            padding:15px;
            border-radius:10px;
            width: fit-content;
            font-size:1.3rem;
            font-weight:bold;
            margin-top:10px;
        ">
            AQI: @aqData.Data.AQI – @GetHealthAdvice(aqData.Data.AQI)
        </div>

        <h5>Pollutants</h5>
        <ul>
            @foreach (var item in aqData.Data.Iaqi)
            {
                <li>@item.Key.ToUpper(): @item.Value.Value</li>
            }
        </ul>
        <h6>Pollutant Key</h6>
        <table class="table table-sm table-bordered" style="width:400px;">
            <thead>
                <tr>
                    <th>Abbreviation</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>H</td><td>Humidity (%)</td></tr>
                <tr><td>NO2</td><td>Nitrogen Dioxide (µg/m³)</td></tr>
                <tr><td>O3</td><td>Ozone (µg/m³)</td></tr>
                <tr><td>P</td><td>Atmospheric Pressure (hPa)</td></tr>
                <tr><td>PM10</td><td>Particulate Matter ≤10µm (µg/m³)</td></tr>
                <tr><td>PM25</td><td>Particulate Matter ≤2.5µm (µg/m³)</td></tr>
                <tr><td>T</td><td>Temperature (°C)</td></tr>
                <tr><td>W</td><td>Wind Speed (m/s)</td></tr>
                <tr><td>WG</td><td>Wind Gust (m/s)</td></tr>
            </tbody>
        </table>


        <h5>PM2.5 Trend</h5>
        <ul>
            @foreach (var day in aqData.Data.Forecast.Daily.PM25)
            {
                <li>@day.Day: @day.Avg</li>
            }
        </ul>

        <h5>PM2.5 Trend Chart</h5>
        <div style="width: 50%; height: 300px;">
            <canvas id="pm25Chart"></canvas>
        </div>
    </div>
}

@code {
    private class SearchModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string City { get; set; } = "";
    }

    private SearchModel searchModel = new();
    private AirQualityResponse? aqData;
    private bool isLoading = false;
    private string errorMessage = "";
    private bool chartNeedsRender = false;

    private List<string> favoriteCities = new();

    private async Task OnSearch()
    {
        isLoading = true;
        errorMessage = "";
        aqData = null;
        chartNeedsRender = false;

        try
        {
            aqData = await AQService.GetAirQualityByCityAsync(searchModel.City);
            if (aqData == null || aqData.Status != "ok")
            {
                errorMessage = "Could not fetch data for this city.";
            }
            else
            {
                chartNeedsRender = true;

                // Save city to favorites if not already saved
                if (!favoriteCities.Contains(searchModel.City, StringComparer.OrdinalIgnoreCase))
                {
                    favoriteCities.Add(searchModel.City);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadFavorite(string city)
    {
        searchModel.City = city;
        await OnSearch();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (chartNeedsRender && aqData?.Data.Forecast?.Daily?.PM25?.Count > 0)
        {
            var labels = aqData.Data.Forecast.Daily.PM25.Select(d => d.Day).ToArray();
            var values = aqData.Data.Forecast.Daily.PM25.Select(d => d.Avg).ToArray();

            await JS.InvokeVoidAsync("renderLineChart", "pm25Chart", labels, values, "PM2.5");

            chartNeedsRender = false;
        }
    }

    private string GetAqiColor(int aqi) => aqi switch
    {
        <= 50 => "green",
        <= 100 => "yellow",
        <= 150 => "orange",
        <= 200 => "red",
        <= 300 => "purple",
        _ => "maroon"
    };

    private string GetHealthAdvice(int aqi) => aqi switch
    {
        <= 50 => "Good for sensitive individuals",
        <= 100 => "Moderate, some respiratory issues possible",
        <= 150 => "Unhealthy for sensitive groups",
        <= 200 => "Unhealthy",
        <= 300 => "Very unhealthy",
        _ => "Hazardous"
    };
}



